"use strict";(self.webpackChunkkraken_ci_website=self.webpackChunkkraken_ci_website||[]).push([[1150],{7164:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>l,default:()=>u,frontMatter:()=>o,metadata:()=>a,toc:()=>c});var t=s(4848),i=s(8453),r=s(4074);const o={id:"guide-kubernetes",title:"Deployment in Kubernetes"},l=void 0,a={id:"guide-kubernetes",title:"Deployment in Kubernetes",description:"Intro",source:"@site/docs/guide-kubernetes.mdx",sourceDirName:".",slug:"/guide-kubernetes",permalink:"/docs/guide-kubernetes",draft:!1,unlisted:!1,editUrl:"https://github.com/kraken-ci/website/edit/master/docs/guide-kubernetes.mdx",tags:[],version:"current",frontMatter:{id:"guide-kubernetes",title:"Deployment in Kubernetes"},sidebar:"someSidebar",previous:{title:"Webhooks Guide",permalink:"/docs/guide-webhooks"},next:{title:"Others",permalink:"/docs/others"}},d={},c=[{value:"Intro",id:"intro",level:2},{value:"Pre-requisites",id:"pre-requisites",level:2},{value:"Kubernetes Clusters",id:"kubernetes-clusters",level:2},{value:"Install in Minikube",id:"install-in-minikube",level:2},{value:"Global Settings",id:"global-settings",level:2},{value:"Configuration in Agents Groups",id:"configuration-in-agents-groups",level:2},{value:"Job Definition",id:"job-definition",level:2},{value:"Run",id:"run",level:2}];function h(e){const n={a:"a",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h2,{id:"intro",children:"Intro"}),"\n",(0,t.jsx)(n.p,{children:"One of the methods of deploying Kraken CI is installing it into\nKubernetes cluster. Kraken CI is natively divided into several\nservices packed in Docker images so they can be nicely laid\nout in the cluster. The other aspect is running Kraken jobs. In this\ncase, they are run in containers natively scheduled onto Kubernetes\nnodes."}),"\n",(0,t.jsx)(n.p,{children:"This guide shows how to install and configure Kraken CI in Kubernetes\nto leverage its potential."}),"\n",(0,t.jsx)(n.h2,{id:"pre-requisites",children:"Pre-requisites"}),"\n",(0,t.jsx)(n.p,{children:"Several things are required to install Kraken CI in Kubernetes using Helm.\nIn short:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://kubernetes.io",children:"Kubernetes"})," cluster and kubectl tool"]}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://helm.sh",children:"Helm tool"})}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Helm is used to deploy several Kraken services and expose them to an external network.\nThese Kraken services are described in ",(0,t.jsx)(n.a,{href:"/docs/architecture",children:"Architecture chapter"}),"."]}),"\n",(0,t.jsx)(n.h2,{id:"kubernetes-clusters",children:"Kubernetes Clusters"}),"\n",(0,t.jsx)(n.p,{children:"There are multiple ways for setting up a Kubernetes cluster. One of\nthe easiest ones that is most often used for experimenting is\nMinikube. There are also managed clusters like EKS (Elastic Kubernetes\nService) in AWS."}),"\n",(0,t.jsx)(n.p,{children:"This manual will show how to install Kraken CI in Minikube but the\nsteps are similar for other Kubernetes environments as well."}),"\n",(0,t.jsx)(n.h2,{id:"install-in-minikube",children:"Install in Minikube"}),"\n",(0,t.jsxs)(n.p,{children:["First, download minikube from ",(0,t.jsx)(n.a,{href:"https://minikube.sigs.k8s.io/docs/",children:"https://minikube.sigs.k8s.io/docs/"}),"."]}),"\n",(0,t.jsx)(n.p,{children:"And then create a cluster:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-console",children:"$ minikube start\n"})}),"\n",(0,t.jsx)(n.p,{children:"Now you may install Kraken CI, but first, let's add a repo with Kraken Helm charts:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-console",children:"$ helm repo add kraken-ci https://kraken.ci/helm-repo/charts\n$ helm repo update\n"})}),"\n",(0,t.jsx)(n.p,{children:"and now install Kraken CI:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-console",children:"$ helm upgrade --install --create-namespace --namespace kraken \\\n  --debug --wait \\\n  --set access.method='external-ips' --set access.external_ips={`minikube ip`} \\\n  kraken-ci kraken-ci/kraken-ci\n"})}),"\n",(0,t.jsx)(n.p,{children:"This command actually upgrades Kraken CI if it is already installed\nbut if it was not yet installed, then it installs it."}),"\n",(0,t.jsxs)(n.p,{children:["More details about using Helm to install Kraken CI can be found in ",(0,t.jsx)(n.a,{href:"/docs/install-helm",children:"installation docs"}),"."]}),"\n",(0,t.jsx)(n.p,{children:"When everything completes successfully, then at the end of the whole\noutput there should be presented short instruction about getting\nthe URL of Kraken service like that:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'NOTES:\nGet the application URL by running these commands:\n  export NODE_PORT=$(kubectl get --namespace kk-1 -o jsonpath="{.spec.ports[0].port}" services ui)\n  export NODE_IP=$(kubectl get nodes --namespace kk-1 -o jsonpath="{.items[0].status.addresses[0].address}")\n  echo http://$NODE_IP:$NODE_PORT\n'})}),"\n",(0,t.jsx)(n.p,{children:"Now you may check if Kraken is working by visiting the URL\ngiven by this code and by checking if Kubernetes is running Kraken's\nservices with this command:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-console",children:"kubectl get all -n kraken\n"})}),"\n",(0,t.jsx)(n.p,{children:"This will show Kraken's pods, services, deployments and replica sets."}),"\n",(0,t.jsx)(n.p,{children:"At this moment, Kraken CI should be operating. Please visit the\nwebsite on the URL presented above. You should see a login page:"}),"\n",(0,t.jsx)(r.A,{img:"qs-login-page.png"}),"\n",(0,t.jsxs)(n.p,{children:["Enter ",(0,t.jsx)(n.code,{children:"admin"})," for Username and ",(0,t.jsx)(n.code,{children:"admin"})," for Password."]}),"\n",(0,t.jsx)(n.h2,{id:"global-settings",children:"Global Settings"}),"\n",(0,t.jsxs)(n.p,{children:["First, let's set some global settings. In Web UI, click ",(0,t.jsx)(n.code,{children:"Settings"})," in\nthe top menu bar."]}),"\n",(0,t.jsxs)(n.p,{children:["In the ",(0,t.jsx)(n.code,{children:"General"})," tab, fill the following fields:"]}),"\n",(0,t.jsx)(r.A,{img:"screen-settings-general.png"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"Kraken Server URL"})," - an URL with a port of the server that is visible inside the Kubernetes cluster"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"MinIO/S3 Address"})," - the IP address and port of Kraken's internal artifacts storage address"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"Clickhouse Proxy Address"})," - the IP address and port of Kraken's internal logs storage address"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["In all these cases minikube IP address can be used. It can be obtained\nusing ",(0,t.jsx)(n.code,{children:"minikube ip"})," command."]}),"\n",(0,t.jsxs)(n.p,{children:["Having set the ",(0,t.jsx)(n.code,{children:"General"})," settings, let's move to the ",(0,t.jsx)(n.code,{children:"Cloud"})," tab."]}),"\n",(0,t.jsx)(r.A,{img:"screen-settings-cloud.png"}),"\n",(0,t.jsxs)(n.p,{children:["Here, please move to Kubernetes section and set only the ",(0,t.jsx)(n.code,{children:"Namespace"}),"\nfield to the value that was provided in ",(0,t.jsx)(n.code,{children:"helm"})," command above (if it\nwas not changed, then it should be ",(0,t.jsx)(n.code,{children:"kraken"}),")."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"API Server URL"})," field must be empty as Kraken CI is installed inside\nKubernetes and it knows where the API server is."]}),"\n",(0,t.jsxs)(n.p,{children:["After saving the settings, check if connectivity is ok using ",(0,t.jsx)(n.code,{children:"Test Kubernetes Access"})," button."]}),"\n",(0,t.jsx)(n.h2,{id:"configuration-in-agents-groups",children:"Configuration in Agents Groups"}),"\n",(0,t.jsxs)(n.p,{children:["After setting global settings, it is possible now to configure aspects\nof spawning Kubernetes pods for Kraken jobs. This can be done on\nKraken -> Agents -> Groups page.  Let's create a new Agents Group by\nclicking ",(0,t.jsx)(n.code,{children:"Add New Group"})," button and naming it ",(0,t.jsx)(n.code,{children:"k8s"}),". The newly created\ngroup's details will be presented on a separate tab. On this tab,\nthere is a section ",(0,t.jsx)(n.code,{children:"Agents Deployment"})," - select Kubernetes. In this\ncase, there is only one field to set: ",(0,t.jsx)(n.code,{children:"Instances Limit"}),"."]}),"\n",(0,t.jsx)(r.A,{img:"screen-agents-groups-cloud-kubernetes.png"}),"\n",(0,t.jsx)(n.p,{children:"This limit value will not allow having more running pods than it - here 5."}),"\n",(0,t.jsx)(n.h2,{id:"job-definition",children:"Job Definition"}),"\n",(0,t.jsxs)(n.p,{children:["Now, to use the defined ",(0,t.jsx)(n.code,{children:"k8s"})," Agents Group, we need to prepare\na project with a branch and a stage. More details about that can be\nfound in ",(0,t.jsx)(n.a,{href:"/docs/guide-intro",children:"Introductory Guide"}),". So let's concentrate\nnow on defining a job."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n    "parent": "root",\n    "triggers": {\n        "parent": True\n    },\n    "configs": [],\n    "jobs": [{\n        "name": "hello",\n        "timeout": 500,\n        "steps": [{\n            "tool": "shell",\n            "cmd": "echo \'hello world\'"\n        }],\n        "environments": [{\n            "system": "ubuntu:20.04",\n            "agents_group": "k8s",\n            "config": "default"\n        }]\n    }]\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:["There is not much difference compared to regular Kraken jobs. The job\nhas a defined environments section where we are pointing to our ",(0,t.jsx)(n.code,{children:"k8s"}),"\nAgents Group. In the case of ",(0,t.jsx)(n.code,{children:"system"})," field here, we have a\n",(0,t.jsx)(n.code,{children:"Ubuntu:20.04"})," Docker image."]}),"\n",(0,t.jsx)(n.h2,{id:"run",children:"Run"}),"\n",(0,t.jsx)(n.p,{children:"Now when a job is assigned to an agents group with configured Agents\nDeployment then a new pod will be spawned for that job if agents\nare not available in the Kraken."}),"\n",(0,t.jsxs)(n.p,{children:["Let's change the view to Branch Results view and trigger a new flow by\nclicking ",(0,t.jsx)(n.code,{children:"Run Flow"})," button. On the run page, the list of jobs shows our\nAWS job:"]}),"\n",(0,t.jsx)(r.A,{img:"screen-k8s-job.png"}),"\n",(0,t.jsx)(n.p,{children:"That's it!"})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(h,{...e})}):h(e)}},4074:(e,n,s)=>{s.d(n,{A:()=>i});s(6540);var t=s(4848);const i=e=>{let{img:n}=e;return(0,t.jsx)("a",{href:"/img/"+n,target:"blank",children:(0,t.jsx)("img",{src:"/img/"+n,style:{boxShadow:"0 10px 10px 5px #777",marginBottom:"30px"}})})}},8453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>l});var t=s(6540);const i={},r=t.createContext(i);function o(e){const n=t.useContext(r);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);