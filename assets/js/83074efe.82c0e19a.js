"use strict";(self.webpackChunkkraken_ci_website=self.webpackChunkkraken_ci_website||[]).push([[1118],{9445:function(e,n,t){t.r(n),t.d(n,{assets:function(){return k},contentTitle:function(){return p},default:function(){return h},frontMatter:function(){return s},metadata:function(){return m},toc:function(){return c}});var a=t(3117),l=t(102),o=(t(7294),t(4137)),r=t(8742),i=(t(5944),["components"]),s={slug:"mlops-with-mlflow-on-kraken-ci",title:"MLOps with MLflow on Kraken CI",authors:"mike",tags:["kraken","devops","mlops","mlflow"]},p=void 0,m={permalink:"/blog/mlops-with-mlflow-on-kraken-ci",editUrl:"https://github.com/kraken-ci/website/edit/master/blog/blog/2022-04-28-mlops-with-mlflow-on-kraken-ci.mdx",source:"@site/blog/2022-04-28-mlops-with-mlflow-on-kraken-ci.mdx",title:"MLOps with MLflow on Kraken CI",description:"Besides building, testing and deploying, Kraken CI is also a pretty",date:"2022-04-28T00:00:00.000Z",formattedDate:"April 28, 2022",tags:[{label:"kraken",permalink:"/blog/tags/kraken"},{label:"devops",permalink:"/blog/tags/devops"},{label:"mlops",permalink:"/blog/tags/mlops"},{label:"mlflow",permalink:"/blog/tags/mlflow"}],readingTime:2.585,hasTruncateMarker:!0,authors:[{name:"Michal Nowikowski",title:"Kraken Founder. I\u2019m software engineer focused on full-stack programming and improving software processes.",url:"https://www.linkedin.com/in/godfryd",imageURL:"https://avatars1.githubusercontent.com/u/176567?s=460&u=4ade22771af9569be24b20278d24ef60da6eb0bb&v=4",key:"mike"}],frontMatter:{slug:"mlops-with-mlflow-on-kraken-ci",title:"MLOps with MLflow on Kraken CI",authors:"mike",tags:["kraken","devops","mlops","mlflow"]},prevItem:{title:"Job Designer and More - 0.962 Release",permalink:"/blog/job-designer-and-more-0-962"},nextItem:{title:"Dark Mode in 0.945 Release",permalink:"/blog/dark-mode-in-0-945"}},k={authorsImageUrls:[void 0]},c=[{value:"MLOps and MLflow",id:"mlops-and-mlflow",level:3},{value:"MLflow in Kraken CI",id:"mlflow-in-kraken-ci",level:3},{value:"Workflow Definition",id:"workflow-definition",level:3},{value:"Execution and Monitoring",id:"execution-and-monitoring",level:3},{value:"Summary",id:"summary",level:3}],d={toc:c};function h(e){var n=e.components,t=(0,l.Z)(e,i);return(0,o.kt)("wrapper",(0,a.Z)({},d,t,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"Besides building, testing and deploying, Kraken CI is also a pretty\nnice tool to build an ",(0,o.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/MLOps"},"MLOps"),"\npipeline. In this article, it will be shown how to leverage Kraken CI to\nbuild a CI workflow for machine learning using\n",(0,o.kt)("a",{parentName:"p",href:"https://mlflow.org/"},"MLflow"),"."),(0,o.kt)("h3",{id:"mlops-and-mlflow"},"MLOps and MLflow"),(0,o.kt)("p",null,"MLOps is a set of practices that aims to build and maintain machine\nlearning models in production reliably and efficiently. One of\nprominent tools in this area is ",(0,o.kt)("a",{parentName:"p",href:"https://mlflow.org/"},"MLflow"),"."),(0,o.kt)("p",null,"MLflow is an open-source platform for managing the end-to-end machine\nlearning lifecycle. It tackles four primary functions:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Tracking experiments to record and compare parameters and results\n(MLflow Tracking)."),(0,o.kt)("li",{parentName:"ul"},"Packaging ML code in a reusable, reproducible form to share\nwith other data scientists or transfer to production (MLflow\nProjects)."),(0,o.kt)("li",{parentName:"ul"},"Managing and deploying models from various ML libraries to a\nvariety of model serving and inference platforms (MLflow Models)."),(0,o.kt)("li",{parentName:"ul"},"Providing a central model store to collaboratively manage the entire\nlifecycle of an MLflow Model, including model versioning, stage\ntransitions, and annotations (MLflow Model Registry).")),(0,o.kt)("h3",{id:"mlflow-in-kraken-ci"},"MLflow in Kraken CI"),(0,o.kt)("p",null,"In the following sections, I will describe how to prepare a workflow\nin Kraken CI to train an ML model. This is an LSTM model that will\npredict stock prices based on historical data."),(0,o.kt)("p",null,"The workflow will be:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"pulling live stock data and preparing it for training (",(0,o.kt)("a",{parentName:"p",href:"https://github.com/Kraken-CI/mlflow-example/blob/master/download_raw_data.py"},"source\n1"),",\n",(0,o.kt)("a",{parentName:"p",href:"https://github.com/Kraken-CI/mlflow-example/blob/master/transform_data.py"},"source\n2"),")")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"performing the training (",(0,o.kt)("a",{parentName:"p",href:"https://github.com/Kraken-CI/mlflow-example/blob/master/train_model.py"},"source 3"),")")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"storing model metrics in Kraken CI for charting"))),(0,o.kt)("p",null,"The MLflow project is described in ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/Kraken-CI/mlflow-example/blob/master/MLproject"},"MLproject"),"."),(0,o.kt)("h3",{id:"workflow-definition"},"Workflow Definition"),(0,o.kt)("p",null,"The whole Kraken CI workload is defined ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/Kraken-CI/mlflow-example/blob/master/.kraken/one.py"},"here"),"."),(0,o.kt)("p",null,"There are 3 steps:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'   "steps": [{\n       "tool": "git",\n       "checkout": "https://github.com/Kraken-CI/mlflow-example.git"\n   }, {\n       "tool": "shell",\n       "cmd": "/opt/conda/bin/mlflow run .",\n       "cwd": "mlflow-example",\n       "timeout": 1200\n   }, {\n       "tool": "values_collect",\n       "files": [{\n           "name": "metrics.json",\n           "namespace": "metrics"\n       }, {\n           "name": "params.json",\n           "namespace": "params"\n       }],\n       "cwd": "mlflow-example"\n   }],\n')),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Checkout mflow example project sources")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Run the mlflow project ie. download data, prepare it, run a\ntraining and at the end store metrics about the trained model to\nmetrics.json")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Upload collected metrics together with hyperparameters from\nparams.json to Kraken server"))),(0,o.kt)("p",null,"The last step allows for charting accuracy and RMS of the model over\nbuilds."),(0,o.kt)("p",null,"There is one more element defined in the workflow: the definition of\nexecution environment:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'   "environments": [{\n       "system": "krakenci/mlflow",\n       "executor": "docker",\n       "agents_group": "all",\n       "config": "default"\n   }]\n')),(0,o.kt)("p",null,"Here we can notice the use of a pre-prepared image with mlflow.\nIt is available in Docker hub:\n",(0,o.kt)("a",{parentName:"p",href:"https://hub.docker.com/r/krakenci/mlflow"},"krakenci/mlflow"),"."),(0,o.kt)("p",null,"The whole example of workflow is present in Kraken lab:\n",(0,o.kt)("a",{parentName:"p",href:"https://lab.kraken.ci/branches/32/ci"},"https://lab.kraken.ci/branches/32/ci"),". Check the steps definitions in\n",(0,o.kt)("a",{parentName:"p",href:"https://lab.kraken.ci/branches/32"},"branch management page"),"."),(0,o.kt)("h3",{id:"execution-and-monitoring"},"Execution and Monitoring"),(0,o.kt)("p",null,"Besides the workflow definition, Kraken UI also shows collected data\nand the charts drawn from this data:\n",(0,o.kt)("a",{parentName:"p",href:"https://lab.kraken.ci/test_case_results/595950"},"https://lab.kraken.ci/test_case_results/595950"),", the charts tab."),(0,o.kt)("p",null,"The right chart shows value of ",(0,o.kt)("inlineCode",{parentName:"p"},"loss")," collected over time:"),(0,o.kt)(r.Z,{img:"screen-values-chart.png",mdxType:"Screen"}),(0,o.kt)("h3",{id:"summary"},"Summary"),(0,o.kt)("p",null,"This article shows how Kraken CI can be used to build an MLOps\npipeline.  The pipeline downloads raw data, prepares the data for\ntraining and then executes the training. The trained model\nmetrics are collected and charted in Kraken UI at the end."))}h.isMDXComponent=!0},8742:function(e,n,t){var a=t(7294);n.Z=function(e){var n=e.img;return a.createElement("a",{href:"/img/"+n,target:"blank"},a.createElement("img",{src:"/img/"+n,style:{boxShadow:"0 10px 10px 5px #777",marginBottom:"30px"}}))}}}]);